name: CI-CD for ride-rent-agent

on:
    push:
        branches:
            - development
            - prod
            - devops-test

permissions:
    id-token: write
    contents: read

jobs:
    build-dev:
        name: Build static export and upload to DEV GCP Project
        runs-on: ubuntu-latest
        environment: deployments-dev
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/devops-test'
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Authenticate to DEV project of Google Cloud (WIF)
                id: auth
                uses: google-github-actions/auth@v3
                with:
                    workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                    project_id: ${{ secrets.GCP_SVC_PROJECT }}

            -   name: Set up Cloud SDK
                uses: google-github-actions/setup-gcloud@v2

            -   name: Set up Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '18'

            -   name: Install dependencies
                run: |
                    npm install

            -   name: Build (development)
                run: npm run build:dev

            -   name: Upload build artifacts to staging prefix in GCS (DEV)
                run: |
                    set -e
                    STAGING_PATH=gs://${{ vars.GCP_BUCKET }}/ride-rent-agent/staging/dev/
                    echo "Uploading dist/ -> ${STAGING_PATH}"
                    gsutil -m rsync -r dist/ ${STAGING_PATH}

    
    build-prod:
        name: Build static export and upload to PROD GCP Project
        runs-on: ubuntu-latest
        environment: deployments-prod
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/prod' || github.ref == 'refs/heads/prd' || github.ref == 'refs/heads/production'
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Authenticate to DEV project of Google Cloud (WIF)
                id: auth
                uses: google-github-actions/auth@v3
                with:
                    workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                    project_id: ${{ secrets.GCP_SVC_PROJECT }}

            -   name: Set up Cloud SDK
                uses: google-github-actions/setup-gcloud@v2

            -   name: Set up Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '18'

            -   name: Install dependencies
                run: |
                    npm install


            -   name: Build (production)
                run: npm run build:prod

            -   name: Upload build artifacts to staging prefix in GCS (PROD)
                run: |
                    set -e
                    STAGING_PATH=gs://${{ vars.GCP_BUCKET }}/ride-rent-agent/staging/prod/
                    echo "Uploading dist/ -> ${STAGING_PATH}"
                    gsutil -m rsync -r dist/ ${STAGING_PATH}
    

    promote-to-dev:
        name: Promote staging to DEV site
        runs-on: ubuntu-latest
        environment: deployments-dev
        needs: build-dev
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            # -   name: Await Approval
            #     uses: trstringer/manual-approval@v1
            #     with:
            #         secret: ${{ secrets.GIT_TOKEN }}
            #         approvers: ${{ secrets.GIT_APPROVERS }}
            #         minimum-approvals: 1
            #         issue-title: "Approve DEV deployment"
            #         issue-body: "Please approve or deny the DEV deployment. Reply with 'approve' or 'deny'."
            #         polling-interval-seconds: 30
            #     timeout-minutes: 120
                    
            -   name: Authenticate to Google Cloud (WIF)
                id: auth
                uses: google-github-actions/auth@v3
                with:
                    workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                    project_id: ${{ secrets.GCP_SVC_PROJECT }}
            
            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2
            
            -   name: Verify GCP auth (debug - masked outputs)
                run: |
                    set -e
                    echo "gcloud auth list:"
                    gcloud auth list || true
                    echo "gcloud config get-value account:"
                    gcloud config get-value account || true
                    echo "Test listing bucket (should succeed if auth+permissions are correct):"
                    gsutil ls -L "gs://${{ vars.GCP_BUCKET }}" || true

            -   name: Promote staging to bucket root (DEV)
                run: |
                    set -e
                    SOURCE=gs://${{ vars.GCP_BUCKET }}/ride-rent-agent/staging/dev/
                    DEST=gs://${{ vars.GCP_BUCKET }}/ride-rent-agent/dev/
                    echo "Syncing ${SOURCE} -> ${DEST}"
                    gsutil -m rsync -r ${SOURCE} ${DEST}

    promote-to-prod:
        name: Promote staging to PROD site
        runs-on: ubuntu-latest
        needs: build-prod
        environment: deployments-prod
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Await Approval
                uses: trstringer/manual-approval@v1
                with:
                    secret: ${{ secrets.GIT_TOKEN }}
                    approvers: ${{ secrets.GIT_APPROVERS }}
                    minimum-approvals: 1
                    issue-title: "Approve PROD deployment"
                    issue-body: "Please approve or deny the PROD deployment. Reply with 'approve' or 'deny'."
                    polling-interval-seconds: 30
                timeout-minutes: 120

            -   name: Authenticate to Google Cloud (WIF)
                id: auth
                uses: google-github-actions/auth@v3
                with:
                    workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                    project_id: ${{ secrets.GCP_SVC_PROJECT }}

            -   name: Promote staging to bucket root (PROD)
                run: |
                    SOURCE=gs://${{ vars.GCP_BUCKET }}/ride-rent-agent/staging/prod/
                    DEST=gs://${{ vars.GCP_BUCKET }}/ride-rent-agent/prod/
                    echo "Syncing ${SOURCE} -> ${DEST}"
                    gsutil -m rsync -r ${SOURCE} ${DEST}
